using Android.App;
using Android.Content;
using Android.OS;
using Android.Runtime;
using Android.Views;
using Android.Widget;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace App1
{
    [Activity(Label = "Activity9", MainLauncher = true)]
    public class Activity9 : Activity
    {
        protected override void OnCreate(Bundle savedInstanceState)
        {
            base.OnCreate(savedInstanceState);

            // Create your application here
            SetContentView(Resource.Layout.layout9);

            Button button1 = FindViewById<Button>(Resource.Id.button1);
            EditText editText1 = FindViewById<EditText>(Resource.Id.editText1);
            //editText1.Text = "BG80BNBG96611020345678";

            string bankCode = "BNBG";
            string branchCode = "9661";
            string accountType = "10";
            string accountNumber = "20345678";

            string iban = GenerateBGIBANFast(bankCode, branchCode, accountType, accountNumber);

            editText1.Text = iban;

            button1.Click += delegate
            {
                string iban = editText1.Text;
                bool valid = IsValidFast(iban);
                button1.Text = valid.ToString();
            };

        }

        public static bool IsValidFast(string iban)
        {
            if (string.IsNullOrWhiteSpace(iban))
                return false;

            iban = iban.Replace(" ", "").ToUpperInvariant();
            if (iban.Length < 15 || iban.Length > 34)
            {
                return false;
            }

            string rearranged = iban.Substring(4) + iban.Substring(0, 4);

            int mod = 0;
            foreach (char c in rearranged)
            {
                if (char.IsDigit(c))
                {
                    mod = (mod * 10 + (c - '0')) % 97;
                }
                else if (char.IsLetter(c))
                {
                    int value = c - 'A' + 10;
                    mod = (mod * 100 + value) % 97;
                }
                else
                {
                    return false;
                }
            }

            return mod == 1;
        }

        public static string GenerateBGIBANFast(string bankCode, string branchCode, string accountType, string accountNumber)
        {
            if (bankCode.Length != 4 || branchCode.Length != 4 || accountType.Length != 2 || accountNumber.Length != 8)
                throw new ArgumentException("Невалидна дължина на BBAN полетата.");

            string bban = bankCode + branchCode + accountType + accountNumber;
            string countryCode = "BG";

            // Placeholder за контролни цифри
            string tempIban = countryCode + "00" + bban;

            // Преместваме първите 4 символа в края
            string rearranged = tempIban.Substring(4) + tempIban.Substring(0, 4);

            // Изчисляваме mod 97 по части
            int mod = 0;
            foreach (char c in rearranged)
            {
                if (char.IsDigit(c))
                {
                    mod = (mod * 10 + (c - '0')) % 97;
                }
                else if (char.IsLetter(c))
                {
                    int value = c - 'A' + 10;
                    // буквите могат да бъдат 2-цифрени (10..35)
                    mod = (mod * 100 + value) % 97;
                }
                else
                {
                    throw new ArgumentException("Невалиден символ в BBAN или кода на страната.");
                }
            }

            int checkDigits = 98 - mod;
            string checkStr = checkDigits.ToString("D2");

            return countryCode + checkStr + bban;
        }

    }
}
